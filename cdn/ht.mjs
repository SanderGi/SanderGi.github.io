"use strict";const old=Symbol("previous state"),element=Symbol("current element"),component=Symbol("parent web component"),jsvars={},urlParams=new URLSearchParams(window.location.search),scopedEval=(e,t,s={})=>Function("old","element","component",...Object.keys(s),'"use strict"; '+t).bind(e)(old,element,component,...Object.values(s));class Signal{constructor(e){this.value=e,this.listeners=new Set}addListener(e,t=void 0){this.listeners.add(e),t&&(t.cleanup||(t.cleanup=[]),t.cleanup.push(()=>this.removeListener(e)))}removeListener(e){this.listeners.delete(e)}emit(){for(const e of this.listeners)e(this.value)}}function createStateSignals(n){var e={[old]:{}};return[e,new Proxy(e,{set(e,t,s){return t in n?n[t]=s:(e[t]||(e[t]=new Signal),e[old][t]=e[t].value,e[t].value=s,e[t].emit()),!0},get(e,t){return[old,element].includes(t)?e[t]:t in n?n[t]:(e[t]||(e[t]=new Signal),e[t].value)},has(e,t){return t in n||t in e}})]}function setDeep(e,t,s,n){for(const o of(t=t.split(".")).slice(0,-1))e=e[o];n?e[t.at(-1)]+=s:e[t.at(-1)]=s}function kebabToCamelCase(e){return e.replace(/-./g,e=>"-"==e[1]?"-":e[1].toUpperCase())}function createSetter(t,s){let n=!1;return t.endsWith("+")&&(n=!0,t=t.slice(0,-1)),t.startsWith(":")?("html"===(t="text"===(t=kebabToCamelCase(t.substring(1)))?"textContent":t)&&(t="innerHTML"),e=>setDeep(s,t,e,n)):n?e=>s.setAttribute(t,s.getAttribute(t)+e):e=>s.setAttribute(t,e)}function setupAttribute(n,t,o,a,r){if(t.name.startsWith("@")){var[e,...s]=t.name.slice(1).split("|");const u=s.reduce((e,t)=>({...e,[t.split(":").at(0)]:t.split(":").at(1)||!0}),{once:!1,capture:!1,passive:!1,throttle:!1,delay:!1,fetch:!1}),d=(s={capture:u.capture,once:u.once,passive:u.passive},e=kebabToCamelCase(e),u.fetch?createFetchHandler(t.value,r,!0===u.fetch?void 0:u.fetch):scopedEval(r,"return "+t.value)),h=u.delay?e=>setTimeout(()=>d.call(r,e),u.delay):e=>d.call(r,e);if(u.throttle){let t=null;n.addEventListener(e,e=>{t=e},s),setInterval(()=>{t&&h(t),t=null},u.throttle)}else n.addEventListener(e,h,s)}else if(t.name.startsWith(":")){const p=createSetter(t.name.slice(1),n);e=/\$\{[^\}]+\}/.test(t.value);let s=p;if(e){const c=new Set,m=new Proxy(r,{get(e,t){return e=e[t],c.has(t)||((o[t]||a[t]).addListener(s,n),c.add(t)),e}});s=e=>p(scopedEval(m,"return `"+t.value+"`"))}else(o[t.value]||a[t.value]).addListener(s,n);s(r[t.value])}else if(t.name.startsWith("#let")){var s=t.name.startsWith("#let-url"),e=t.name.startsWith("#let-local"),i=t.name.startsWith("#let-session"),[l,...c]=t.name.split(":")[1].split("|");const f=kebabToCamelCase(l);l=s?urlParams.get(f):e?localStorage.getItem(f):i?sessionStorage.getItem(f):null,r[f]=l??scopedEval(r,"return "+t.value);for(const v of c)(o[v]||a[v]).addListener(()=>{r[f]=scopedEval(r,"return "+t.value)},n);i=o[f]||a[f],s?i.addListener(e=>{urlParams.set(f,e),window.history.replaceState({},"",location.pathname+"?"+urlParams+location.hash)},n):e?i.addListener(e=>{localStorage.setItem(f,e)},n):sessionStorage&&i.addListener(e=>{sessionStorage.setItem(f,e)},n)}else"#jsvar"===t.name&&(jsvars[t.value]=r)}function createFetchHandler(r,i,l){return async e=>{var t=r.split("->",1)[0];if((e=await scopedEval(i,`return fetch(${t})`,{e:e})).ok){var s=r.replace(t,"").replace("->","").trim();if("this"==s)for(var[n,o]of Object.entries(await e.json()))i[n]=o;else if("console"==s){var a=await e[l??"text"]();console.log(a)}else if(s in i){const a=await e[l??"text"]();i[s]=a}else insertAtTarget(s,await e.text())}else console.error(`Failed to fetch(${t}), got status ${e.status} - ${e.statusText}: `+e.text)}}function insertAtTarget(e,t){var[e,s]=e.split("->",2);"outerHTML"===s?document.querySelector(e.trim()).outerHTML=t:"textContent"===s?document.querySelector(e.trim()).textContent=t:s?document.querySelector(e.trim()).insertAdjacentHTML(s.trim(),t):document.querySelector(e.trim()).innerHTML=t}function setupComponent(a,r){var e=a.attributes["#component"].value;const i=[...a.attributes].map(e=>e.name).filter(e=>!["#",":","@"].includes(e[0]));class t extends HTMLElement{static observedAttributes=i;constructor(){super();var e=this.attachShadow({mode:"open"});e.appendChild(a.content.cloneNode(!0)),[this.state,this.$state]=createStateSignals({[component]:this}),this.state[element]=this;for(const s of i){var t=scopedEval(r,"return "+a.attributes[s].value);this.setAttribute(s,t),this.$state[s]=t}for(const n of a.attributes)setupAttribute(a,n,this.state,this.state,this.$state);this.onConnectedScripts=[],this.onDisconnectedScripts=[];for(const o of e.children)"SCRIPT"===o.tagName&&(o.hasAttribute("#onConnected")?this.onConnectedScripts.push(o.textContent):o.hasAttribute("#onDisconnected")?this.onDisconnectedScripts.push(o.textContent):scopedEval(this.$state,o.textContent))}connectedCallback(){setupChildren(this.shadowRoot,this.state,this.$state),mutationObserver.observe(this.shadowRoot,{childList:!0,subtree:!0});for(const e of this.onConnectedScripts)scopedEval(this.$state,e)}disconnectedCallback(){for(const e of this.onDisconnectedScripts)scopedEval(this.$state,e);delete this.state,delete this.$state,undoSetup(this.shadowRoot)}attributeChangedCallback(e,t,s){this.$state[e]=s}}window.customElements.define(e,t)}function setupChildren(e,t,s){for(const n of e.children)setup(n,t,s)}function setup(e,t={},s={}){var[n,o]=createStateSignals(s);if(e.state=n,e.$state=o,"TEMPLATE"===(n[element]=e).tagName&&e.hasAttribute("#component"))setupComponent(e,o);else{for(const a of e.attributes)setupAttribute(e,a,t,n,o);setupChildren(e,Object.assign({},n,t),o)}}for(const Ta of document.querySelectorAll("head link"))Ta.hasAttribute("#include")&&fetch(Ta.attributes.href.value).then(e=>e.text().then(e=>{insertAtTarget(Ta.getAttribute("#include")||"body -> beforeEnd",e)}));function undoSetup(e){for(const t of e.children)undoSetup(t);for(const s of e.cleanup||[])s();delete e.state,delete e.$state}const mutationObserver=new MutationObserver(e=>{for(const t of e){for(const s of t.addedNodes)s.nodeType===Node.ELEMENT_NODE&&setup(s,s.parentElement.state,s.parentElement.$state);for(const n of t.removedNodes)n.nodeType===Node.ELEMENT_NODE&&undoSetup(n)}});await(new Promise(e=>{document.addEventListener("DOMContentLoaded",()=>{setup(document.body),e()})})),mutationObserver.observe(document.body,{childList:!0,subtree:!0});export{old,element,component,jsvars};
